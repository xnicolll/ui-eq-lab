{% extends "base.html" %}

{% block content %}
<div class="content-section quiz-page">
    <div class="quiz-container">
        <div class="quiz-header">
            <h3>{{ question.question }}</h3>
        </div>

        <div class="quiz-content">
            {% if question.type == "slider" %}
                <div class="eq-controls">
                    <div class="eq-sliders">
                        {% for freq in question.frequencies %}
                        <div class="eq-slider">
                            <input type="range" class="eq-control" data-frequency="{{ freq }}" min="-12" max="12" value="{% if saved_answer and saved_answer.value %}{{ saved_answer.value[loop.index0] }}{% else %}0{% endif %}" step="0.1">
                            <label>{{ freq }} {% if freq >= 1000 %}kHz{% else %}Hz{% endif %}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="slider-controls">
                    <button class="nav-btn reset-btn">Reset</button>
                </div>
            {% else %}
                <div class="audio-comparison">
                    <div class="audio-section">
                        <h4>Before</h4>
                        <div class="play-button" data-audio="{{ question.audio.before }}">
                            <div class="play-icon"></div>
                        </div>
                    </div>

                    <div class="audio-section">
                        <h4>Processed</h4>
                        <div class="play-button" data-audio="{{ question.audio.after }}">
                            <div class="play-icon"></div>
                        </div>
                    </div>
                </div>

                <div class="options">
                    {% for option in question.options %}
                    <label class="option">
                        <input type="radio" name="q{{ question.id }}" value="{{ option.lower().replace(' ', '-') }}" {% if saved_answer and saved_answer.value == option.lower().replace(' ', '-') %}checked{% endif %}>
                        <span>{{ option }}</span>
                    </label>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="navigation-controls">
                {% if question.id > 1 %}
                <a href="{{ url_for('quiz_specific', question_id=question.id-1) }}" class="nav-btn prev-btn">Previous</a>
                {% endif %}
                <button class="nav-btn next-btn" {% if not question.type == "slider" and not saved_answer %}disabled{% endif %}>
                    {% if question.id == 5 %}View Results{% else %}Next{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<div id="quiz-data" 
    data-question-id="{{ question.id }}"
    data-correct-answer="{{ question.correct_answer }}"
    data-correct-threshold="{{ question.correct_threshold }}">
</div>

<!-- Exit Confirmation Modal -->
<div class="modal" id="exitConfirmModal" style="display: none;">
    <div class="modal-content">
        <h3>Are you sure you want to exit the quiz?</h3>
        <div class="modal-buttons">
            <button class="nav-btn" id="cancel-exit">No, Continue Quiz</button>
            <button class="nav-btn" id="confirm-exit">Yes, Exit Quiz</button>
        </div>
    </div>
</div>

<style>
.slider-controls {
    margin-top: 2rem;
    text-align: center;
}

.reset-btn {
    background: none;
    border: 1px solid var(--dark);
    padding: 0.5rem 1.5rem;
    font-family: 'Roboto', sans-serif;
    font-weight: 300;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--dark);
}

.reset-btn:hover {
    background-color: var(--dark);
    color: var(--light);
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(58, 50, 56, 0.8); /* var(--dark) with opacity */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: var(--light);
    padding: 2rem;
    border: 1px solid var(--dark);
    max-width: 400px;
    width: 90%;
    text-align: center;
    border-radius: 0;  /* Square edges */
}

.modal-content h3 {
    color: var(--dark);
    margin-bottom: 2rem;
    font-family: 'Roboto', sans-serif;
    font-weight: 300;
    font-size: 1.2rem;  /* Smaller text */
}

.modal-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
}

.modal-buttons .nav-btn {
    min-width: 150px;
    border-radius: 0;  /* Square edges for buttons */
}

#cancel-exit {
    background-color: var(--light);  /* Same as background */
    color: var(--dark);
    border: 1px solid var(--dark);
}

#cancel-exit:hover {
    background-color: var(--dark);
    color: var(--light);
}

#confirm-exit {
    background-color: var(--dark);
    color: var(--light);
    border: 1px solid var(--dark);
}

#confirm-exit:hover {
    background-color: var(--light);
    color: var(--dark);
}
</style>

<script src="{{ url_for('static', filename='js/quiz.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('exitConfirmModal');
    const cancelBtn = document.getElementById('cancel-exit');
    const confirmBtn = document.getElementById('confirm-exit');
    let destinationUrl = null;

    // Handle navigation link clicks
    document.querySelectorAll('.nav-link').forEach(link => {
        if (!link.href.includes('/quiz')) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                destinationUrl = this.href;
                modal.style.display = 'flex';
            });
        }
    });

    // Handle browser back/forward buttons
    window.addEventListener('beforeunload', function(e) {
        if (!e.currentTarget.performance.navigation.type) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Handle modal buttons
    cancelBtn.addEventListener('click', function() {
        modal.style.display = 'none';
        destinationUrl = null;
    });

    confirmBtn.addEventListener('click', function() {
        if (destinationUrl) {
            window.location.href = destinationUrl;
        } else {
            window.history.back();
        }
    });

    // Close modal if clicked outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            destinationUrl = null;
        }
    });
});
</script>
{% endblock %}

<!-- Question 2 Template -->
{% if question_number == 2 %}
<div class="content-section quiz-page">
    <div class="quiz-container">
        <div class="quiz-header">
            <h3>What technique has been applied?</h3>
        </div>

        <div class="quiz-content">
            <div class="audio-comparison">
                <div class="audio-section">
                    <h4>Before</h4>
                    <div class="play-button" data-audio="/static/audio/tylerthecreator_normal.mp3">
                        <div class="play-icon"></div>
                    </div>
                </div>

                <div class="audio-section">
                    <h4>Processed</h4>
                    <div class="play-button" data-audio="/static/audio/tylerthecreator_hipass.mp3">
                        <div class="play-icon"></div>
                    </div>
                </div>
            </div>

            <div class="options">
                <label class="option">
                    <input type="radio" name="q2" value="high-pass">
                    <span>High Pass</span>
                </label>
                <label class="option">
                    <input type="radio" name="q2" value="low-pass">
                    <span>Low Pass</span>
                </label>
            </div>

            <div class="navigation-controls">
                <button class="nav-btn prev-btn">Previous</button>
                <button class="nav-btn next-btn">Next</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const playButtons = document.querySelectorAll('.play-button');
    let currentAudio = null;

    // Handle play button clicks
    playButtons.forEach(button => {
        const audioUrl = button.dataset.audio;
        const audio = new Audio(audioUrl);
        
        button.addEventListener('click', function() {
            if (currentAudio && currentAudio !== audio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio.playButton.classList.remove('playing');
            }
            
            if (audio.paused) {
                audio.play();
                button.classList.add('playing');
                currentAudio = audio;
                currentAudio.playButton = button;
            } else {
                audio.pause();
                audio.currentTime = 0;
                button.classList.remove('playing');
                currentAudio = null;
            }
        });

        // Add ended event listener
        audio.addEventListener('ended', function() {
            button.classList.remove('playing');
            currentAudio = null;
        });
    });

    // Handle answer selection
    const options = document.querySelectorAll('.option input');
    const nextButton = document.querySelector('.next-btn');
    
    options.forEach(option => {
        option.addEventListener('change', function() {
            nextButton.disabled = false;
        });
    });

    // Handle navigation
    nextButton.addEventListener('click', function() {
        const selectedAnswer = document.querySelector('input[name="q2"]:checked');
        if (selectedAnswer && selectedAnswer.value === 'high-pass') {
            // Correct answer
            window.location.href = '/quiz/3';  // Navigate to next question
        } else {
            // Wrong answer
            alert('Try again!');
        }
    });
});
</script>
{% endif %} 