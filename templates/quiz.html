{% extends "base.html" %}

{% block content %}
<div class="content-section quiz-page">
    <div class="quiz-container">
        <div class="quiz-header">
            <h3>{{ question.question }}</h3>
        </div>

        <div class="quiz-content">
            {% if question.type == "slider" %}
                <div class="eq-controls">
                    <div class="eq-sliders">
                        {% for freq in question.frequencies %}
                        <div class="eq-slider">
                            <input type="range" class="eq-control" data-frequency="{{ freq }}" min="-12" max="12" value="{% if saved_answer and saved_answer.value %}{{ saved_answer.value[loop.index0] }}{% else %}0{% endif %}" step="0.1">
                            <label>{{ freq }} {% if freq >= 1000 %}kHz{% else %}Hz{% endif %}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="slider-controls">
                    <button class="nav-btn reset-btn">Reset</button>
                </div>
            {% else %}
                <div class="audio-comparison">
                    <div class="audio-section">
                        <h4>Before</h4>
                        <div class="play-button" data-audio="{{ question.audio.before }}">
                            <div class="play-icon"></div>
                        </div>
                    </div>

                    <div class="audio-section">
                        <h4>Processed</h4>
                        <div class="play-button" data-audio="{{ question.audio.after }}">
                            <div class="play-icon"></div>
                        </div>
                    </div>
                </div>

                <div class="options">
                    {% for option in question.options %}
                    <label class="option">
                        <input type="radio" name="q{{ question.id }}" value="{{ option.lower().replace(' ', '-') }}" {% if saved_answer and saved_answer.value == option.lower().replace(' ', '-') %}checked{% endif %}>
                        <span>{{ option }}</span>
                    </label>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="navigation-controls">
                {% if question.id > 1 %}
                <a href="{{ url_for('quiz_specific', question_id=question.id-1) }}" class="nav-btn prev-btn">Previous</a>
                {% endif %}
                <button class="nav-btn next-btn" {% if not question.type == "slider" and not saved_answer %}disabled{% endif %}>Next</button>
            </div>
        </div>
    </div>
</div>

<style>
.slider-controls {
    margin-top: 2rem;
    text-align: center;
}

.reset-btn {
    background: none;
    border: 1px solid var(--dark);
    padding: 0.5rem 1.5rem;
    font-family: 'Roboto', sans-serif;
    font-weight: 300;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--dark);
}

.reset-btn:hover {
    background-color: var(--dark);
    color: var(--light);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const nextButton = document.querySelector('.next-btn');

    {% if question.type == "slider" %}
        // Handle slider question
        const sliders = document.querySelectorAll('.eq-control');
        const resetButton = document.querySelector('.reset-btn');
        
        // Reset button functionality
        resetButton.addEventListener('click', function() {
            sliders.forEach(slider => {
                slider.value = 0;
            });
        });
        
        nextButton.addEventListener('click', function() {
            const sliderValues = Array.from(sliders).map(slider => ({
                frequency: parseInt(slider.dataset.frequency),
                value: parseFloat(slider.value)
            }));
            
            // Get all slider values for storage
            const sliderValuesArray = sliderValues.map(sv => sv.value);
            
            // Check if the values create a low pass filter at 1000 Hz
            const isCorrect = sliderValues.every(slider => {
                if (slider.frequency > 1000) {
                    return slider.value <= {{ question.correct_threshold }};
                }
                return true;
            });
            
            // Store the answer
            fetch('/store_answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question_id: {{ question.id }},
                    answer_value: sliderValuesArray,
                    is_correct: isCorrect
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Answer stored:', data);
                {% if question.id == 5 %}
                window.location.href = '{{ url_for("results") }}';
                {% else %}
                window.location.href = '{{ url_for("quiz_specific", question_id=question.id+1) }}';
                {% endif %}
            })
            .catch(error => console.error('Error:', error));
        });
    {% else %}
        const playButtons = document.querySelectorAll('.play-button');
        let currentAudio = null;

        // Handle play button clicks
        playButtons.forEach(button => {
            const audioUrl = button.dataset.audio;
            const audio = new Audio(audioUrl);
            
            button.addEventListener('click', function() {
                if (currentAudio && currentAudio !== audio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio.playButton.classList.remove('playing');
                }
                
                if (audio.paused) {
                    audio.play();
                    button.classList.add('playing');
                    currentAudio = audio;
                    currentAudio.playButton = button;
                } else {
                    audio.pause();
                    audio.currentTime = 0;
                    button.classList.remove('playing');
                    currentAudio = null;
                }
            });

            // Add ended event listener
            audio.addEventListener('ended', function() {
                button.classList.remove('playing');
                currentAudio = null;
            });
        });

        // Handle answer selection
        const options = document.querySelectorAll('.option input');
        
        options.forEach(option => {
            option.addEventListener('change', function() {
                nextButton.disabled = false;
            });
        });

        // Handle navigation for multiple choice
        nextButton.addEventListener('click', function() {
            const selectedAnswer = document.querySelector(`input[name="q{{ question.id }}"]:checked`);
            if (selectedAnswer) {
                // Store the answer
                fetch('/store_answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question_id: {{ question.id }},
                        answer_value: selectedAnswer.value,
                        is_correct: selectedAnswer.value === '{{ question.correct_answer }}'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Answer stored:', data);
                    {% if question.id == 5 %}
                    window.location.href = '{{ url_for("results") }}';
                    {% else %}
                    window.location.href = '{{ url_for("quiz_specific", question_id=question.id+1) }}';
                    {% endif %}
                })
                .catch(error => console.error('Error:', error));
            }
        });
    {% endif %}
});
</script>
{% endblock %}

<!-- Question 2 Template -->
{% if question_number == 2 %}
<div class="content-section quiz-page">
    <div class="quiz-container">
        <div class="quiz-header">
            <h3>What technique has been applied?</h3>
        </div>

        <div class="quiz-content">
            <div class="audio-comparison">
                <div class="audio-section">
                    <h4>Before</h4>
                    <div class="play-button" data-audio="/static/audio/tylerthecreator_normal.mp3">
                        <div class="play-icon"></div>
                    </div>
                </div>

                <div class="audio-section">
                    <h4>Processed</h4>
                    <div class="play-button" data-audio="/static/audio/tylerthecreator_hipass.mp3">
                        <div class="play-icon"></div>
                    </div>
                </div>
            </div>

            <div class="options">
                <label class="option">
                    <input type="radio" name="q2" value="high-pass">
                    <span>High Pass</span>
                </label>
                <label class="option">
                    <input type="radio" name="q2" value="low-pass">
                    <span>Low Pass</span>
                </label>
            </div>

            <div class="navigation-controls">
                <button class="nav-btn prev-btn">Previous</button>
                <button class="nav-btn next-btn">Next</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const playButtons = document.querySelectorAll('.play-button');
    let currentAudio = null;

    // Handle play button clicks
    playButtons.forEach(button => {
        const audioUrl = button.dataset.audio;
        const audio = new Audio(audioUrl);
        
        button.addEventListener('click', function() {
            if (currentAudio && currentAudio !== audio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio.playButton.classList.remove('playing');
            }
            
            if (audio.paused) {
                audio.play();
                button.classList.add('playing');
                currentAudio = audio;
                currentAudio.playButton = button;
            } else {
                audio.pause();
                audio.currentTime = 0;
                button.classList.remove('playing');
                currentAudio = null;
            }
        });

        // Add ended event listener
        audio.addEventListener('ended', function() {
            button.classList.remove('playing');
            currentAudio = null;
        });
    });

    // Handle answer selection
    const options = document.querySelectorAll('.option input');
    const nextButton = document.querySelector('.next-btn');
    
    options.forEach(option => {
        option.addEventListener('change', function() {
            nextButton.disabled = false;
        });
    });

    // Handle navigation
    nextButton.addEventListener('click', function() {
        const selectedAnswer = document.querySelector('input[name="q2"]:checked');
        if (selectedAnswer && selectedAnswer.value === 'high-pass') {
            // Correct answer
            window.location.href = '/quiz/3';  // Navigate to next question
        } else {
            // Wrong answer
            alert('Try again!');
        }
    });
});
</script>
{% endif %} 